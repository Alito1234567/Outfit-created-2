<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Monster Survivor 2D</title>
    <style>
        body { margin: 0; overflow: hidden; background: #2c3e50; font-family: sans-serif; }
        canvas { display: block; }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
            pointer-events: none;
        }
        #hp-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 25px;
            background: #444;
            border: 3px solid #fff;
        }
        #hp-bar {
            width: 100%;
            height: 100%;
            background: #e74c3c;
            transition: width 0.2s;
        }
    </style>
</head>
<body>

    <div id="ui">
        <strong>KONTROLLER:</strong><br>
        Flytt: WASD | Bil: E | Plukk opp stav: T<br>
        Sikt: Mus | Skyt: Venstreklikk
    </div>

    <div id="hp-container"><div id="hp-bar"></div></div>

    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const keys = {};
const worldSize = 3000;
const camera = { x: 0, y: 0 };

// Spiller data
const player = {
    x: 500, y: 500,
    size: 20,
    speed: 4,
    hp: 100,
    maxHp: 100,
    hasWeapon: false,
    inVehicle: false
};

// Objekter i verden
const projectiles = [];
const particles = [];
const trees = Array.from({length: 40}, () => ({
    x: Math.random() * worldSize,
    y: Math.random() * worldSize
}));

const monsters = Array.from({length: 10}, () => ({
    x: Math.random() * worldSize,
    y: Math.random() * worldSize,
    hp: 1,
    speed: 1.5
}));

const staffItem = { x: 600, y: 600, active: true };

// Bil
const car = { x: 800, y: 800, w: 50, h: 90, angle: 0, speed: 0, friction: 0.97 };

// Input
window.addEventListener("keydown", (e) => keys[e.key.toLowerCase()] = true);
window.addEventListener("keyup", (e) => keys[e.key.toLowerCase()] = false);
window.addEventListener("mousedown", () => {
    if (player.hasWeapon && !player.inVehicle) shoot();
});

function shoot() {
    const angle = Math.atan2(mouseY + camera.y - player.y, mouseX + camera.x - player.x);
    projectiles.push({
        x: player.x,
        y: player.y,
        vx: Math.cos(angle) * 10,
        vy: Math.sin(angle) * 10
    });
}

let mouseX = 0, mouseY = 0;
window.addEventListener("mousemove", (e) => {
    mouseX = e.clientX;
    mouseY = e.clientY;
});

window.addEventListener("keydown", (e) => {
    if (e.key.toLowerCase() === 't' && !player.inVehicle) {
        if (Math.hypot(player.x - staffItem.x, player.y - staffItem.y) < 50) {
            player.hasWeapon = true;
            staffItem.active = false;
        }
    }
    if (e.key.toLowerCase() === 'e') {
        if (!player.inVehicle && Math.hypot(player.x - car.x, player.y - car.y) < 70) {
            player.inVehicle = true;
        } else if (player.inVehicle) {
            player.inVehicle = false;
            player.x += 60;
        }
    }
});

function update() {
    // Bevegelse
    if (!player.inVehicle) {
        if (keys['w']) player.y -= player.speed;
        if (keys['s']) player.y += player.speed;
        if (keys['a']) player.x -= player.speed;
        if (keys['d']) player.x += player.speed;
    } else {
        if (keys['w']) car.speed += 0.2;
        if (keys['s']) car.speed -= 0.1;
        car.speed *= car.friction;
        if (Math.abs(car.speed) > 0.1) {
            if (keys['a']) car.angle -= 0.05;
            if (keys['d']) car.angle += 0.05;
        }
        car.x += Math.cos(car.angle) * car.speed;
        car.y += Math.sin(car.angle) * car.speed;
        player.x = car.x; player.y = car.y;
    }

    // Prosjektiler og kollisjon
    projectiles.forEach((p, pi) => {
        p.x += p.vx; p.y += p.vy;
        monsters.forEach((m, mi) => {
            if (Math.hypot(p.x - m.x, p.y - m.y) < 25) {
                projectiles.splice(pi, 1);
                // Lag "splat" partikler
                for(let i=0; i<5; i++) particles.push({x: m.x, y: m.y, vx: (Math.random()-0.5)*4, vy: (Math.random()-0.5)*4, life: 30});
                monsters.splice(mi, 1);
            }
        });
    });

    // Monster AI og skade
    monsters.forEach(m => {
        const dist = Math.hypot(player.x - m.x, player.y - m.y);
        if (dist < 400) {
            m.x += ((player.x - m.x) / dist) * m.speed;
            m.y += ((player.y - m.y) / dist) * m.speed;
        }
        if (dist < 30 && !player.inVehicle) {
            player.hp -= 0.5;
            document.getElementById("hp-bar").style.width = player.hp + "%";
        }
    });

    if (player.hp <= 0) location.reload();

    camera.x = player.x - canvas.width / 2;
    camera.y = player.y - canvas.height / 2;
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(-camera.x, -camera.y);

    // Bakgrunn
    ctx.fillStyle = "#27ae60";
    ctx.fillRect(0, 0, worldSize, worldSize);

    // TrÃ¦r
    trees.forEach(t => {
        ctx.fillStyle = "#795548"; ctx.fillRect(t.x-5, t.y, 10, 20);
        ctx.fillStyle = "#1b5e20"; ctx.beginPath(); ctx.arc(t.x, t.y, 20, 0, Math.PI*2); ctx.fill();
    });

    if (staffItem.active) {
        ctx.fillStyle = "gold"; ctx.fillRect(staffItem.x, staffItem.y, 10, 30);
    }

    // Monstre
    monsters.forEach(m => {
        ctx.fillStyle = "red"; ctx.beginPath(); ctx.arc(m.x, m.y, 15, 0, Math.PI*2); ctx.fill();
    });

    // Partikler (Splat)
    particles.forEach((p, i) => {
        ctx.fillStyle = "rgba(255, 0, 0, "+p.life/30+")";
        ctx.fillRect(p.x, p.y, 4, 4);
        p.x += p.vx; p.y += p.vy; p.life--;
        if(p.life <= 0) particles.splice(i, 1);
    });

    // Skudd
    projectiles.forEach(p => {
        ctx.fillStyle = "yellow"; ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill();
    });

    // Bil
    ctx.save(); ctx.translate(car.x, car.y); ctx.rotate(car.angle);
    ctx.fillStyle = "#333"; ctx.fillRect(-car.w/2, -car.h/2, car.w, car.h); ctx.restore();

    // Spiller
    if (!player.inVehicle) {
        ctx.fillStyle = "#3498db"; ctx.beginPath(); ctx.arc(player.x, player.y, player.size, 0, Math.PI*2); ctx.fill();
    }

    ctx.restore();
    requestAnimationFrame(draw);
}

setInterval(update, 1000/60);
draw();
</script>
</body>
</html>
